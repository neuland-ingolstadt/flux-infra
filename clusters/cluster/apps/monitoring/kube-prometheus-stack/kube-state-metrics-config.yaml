# kube-state-metrics configuration for Flux custom resource metrics
# This config is merged with the HelmRelease values
customResourceState:
  enabled: true
  config:
    spec:
      resources:
        # GitRepository
        - groupVersionKind:
            group: source.toolkit.fluxcd.io
            version: v1
            kind: GitRepository
          metricNamePrefix: gotk
          metrics:
            - name: "resource_info"
              help: "The current state of a GitOps Toolkit resource."
              each:
                type: Info
                info:
                  labelsFromPath:
                    name: [metadata, name]
                    customresource_group: [apiVersion]
                    customresource_kind: [kind]
                    customresource_version: [apiVersion]
              labelsFromPath:
                exported_namespace: [metadata, namespace]
                suspended: [spec, suspend]
                ready: [status, conditions, "[type=Ready]", status]
                revision: [status, artifact, revision]
                url: [spec, url]
        # OCIRepository
        - groupVersionKind:
            group: source.toolkit.fluxcd.io
            version: v1
            kind: OCIRepository
          metricNamePrefix: gotk
          metrics:
            - name: "resource_info"
              help: "The current state of a GitOps Toolkit resource."
              each:
                type: Info
                info:
                  labelsFromPath:
                    name: [metadata, name]
                    customresource_group: [apiVersion]
                    customresource_kind: [kind]
                    customresource_version: [apiVersion]
              labelsFromPath:
                exported_namespace: [metadata, namespace]
                suspended: [spec, suspend]
                ready: [status, conditions, "[type=Ready]", status]
                revision: [status, artifact, revision]
                url: [spec, url]
        # Bucket
        - groupVersionKind:
            group: source.toolkit.fluxcd.io
            version: v1
            kind: Bucket
          metricNamePrefix: gotk
          metrics:
            - name: "resource_info"
              help: "The current state of a GitOps Toolkit resource."
              each:
                type: Info
                info:
                  labelsFromPath:
                    name: [metadata, name]
                    customresource_group: [apiVersion]
                    customresource_kind: [kind]
                    customresource_version: [apiVersion]
              labelsFromPath:
                exported_namespace: [metadata, namespace]
                suspended: [spec, suspend]
                ready: [status, conditions, "[type=Ready]", status]
                revision: [status, artifact, revision]
                endpoint: [spec, endpoint]
                bucket_name: [spec, bucketName]
        # HelmRepository
        - groupVersionKind:
            group: source.toolkit.fluxcd.io
            version: v1
            kind: HelmRepository
          metricNamePrefix: gotk
          metrics:
            - name: "resource_info"
              help: "The current state of a GitOps Toolkit resource."
              each:
                type: Info
                info:
                  labelsFromPath:
                    name: [metadata, name]
                    customresource_group: [apiVersion]
                    customresource_kind: [kind]
                    customresource_version: [apiVersion]
              labelsFromPath:
                exported_namespace: [metadata, namespace]
                suspended: [spec, suspend]
                ready: [status, conditions, "[type=Ready]", status]
                revision: [status, artifact, revision]
                url: [spec, url]
        # HelmChart
        - groupVersionKind:
            group: source.toolkit.fluxcd.io
            version: v1
            kind: HelmChart
          metricNamePrefix: gotk
          metrics:
            - name: "resource_info"
              help: "The current state of a GitOps Toolkit resource."
              each:
                type: Info
                info:
                  labelsFromPath:
                    name: [metadata, name]
                    customresource_group: [apiVersion]
                    customresource_kind: [kind]
                    customresource_version: [apiVersion]
              labelsFromPath:
                exported_namespace: [metadata, namespace]
                suspended: [spec, suspend]
                ready: [status, conditions, "[type=Ready]", status]
                revision: [status, artifact, revision]
                chart_name: [spec, chart]
                chart_version: [status, artifact, version]
        # Kustomization
        - groupVersionKind:
            group: kustomize.toolkit.fluxcd.io
            version: v1
            kind: Kustomization
          metricNamePrefix: gotk
          metrics:
            - name: "resource_info"
              help: "The current state of a GitOps Toolkit resource."
              each:
                type: Info
                info:
                  labelsFromPath:
                    name: [metadata, name]
                    customresource_group: [apiVersion]
                    customresource_kind: [kind]
                    customresource_version: [apiVersion]
              labelsFromPath:
                exported_namespace: [metadata, namespace]
                suspended: [spec, suspend]
                ready: [status, conditions, "[type=Ready]", status]
                revision: [status, lastAppliedRevision]
                source_name: [spec, sourceRef, name]
        # HelmRelease
        - groupVersionKind:
            group: helm.toolkit.fluxcd.io
            version: v2
            kind: HelmRelease
          metricNamePrefix: gotk
          metrics:
            - name: "resource_info"
              help: "The current state of a GitOps Toolkit resource."
              each:
                type: Info
                info:
                  labelsFromPath:
                    name: [metadata, name]
                    customresource_group: [apiVersion]
                    customresource_kind: [kind]
                    customresource_version: [apiVersion]
              labelsFromPath:
                exported_namespace: [metadata, namespace]
                suspended: [spec, suspend]
                ready: [status, conditions, "[type=Ready]", status]
                revision: [status, lastAppliedRevision]
                chart_name: [spec, chart, spec, chart]
                chart_app_version: [status, current, appVersion]
                chart_source_name: [spec, chart, spec, sourceRef, name]
                chart_ref_name: [spec, chart, spec, sourceRef, name]
        # ImageRepository
        - groupVersionKind:
            group: image.toolkit.fluxcd.io
            version: v1beta2
            kind: ImageRepository
          metricNamePrefix: gotk
          metrics:
            - name: "resource_info"
              help: "The current state of a GitOps Toolkit resource."
              each:
                type: Info
                info:
                  labelsFromPath:
                    name: [metadata, name]
                    customresource_group: [apiVersion]
                    customresource_kind: [kind]
                    customresource_version: [apiVersion]
              labelsFromPath:
                exported_namespace: [metadata, namespace]
                suspended: [spec, suspend]
                ready: [status, conditions, "[type=Ready]", status]
                image: [spec, image]
        # ImagePolicy
        - groupVersionKind:
            group: image.toolkit.fluxcd.io
            version: v1beta2
            kind: ImagePolicy
          metricNamePrefix: gotk
          metrics:
            - name: "resource_info"
              help: "The current state of a GitOps Toolkit resource."
              each:
                type: Info
                info:
                  labelsFromPath:
                    name: [metadata, name]
                    customresource_group: [apiVersion]
                    customresource_kind: [kind]
                    customresource_version: [apiVersion]
              labelsFromPath:
                exported_namespace: [metadata, namespace]
                suspended: [spec, suspend]
                ready: [status, conditions, "[type=Ready]", status]
                source_name: [spec, imageRepositoryRef, name]
        # ImageUpdateAutomation
        - groupVersionKind:
            group: image.toolkit.fluxcd.io
            version: v1beta2
            kind: ImageUpdateAutomation
          metricNamePrefix: gotk
          metrics:
            - name: "resource_info"
              help: "The current state of a GitOps Toolkit resource."
              each:
                type: Info
                info:
                  labelsFromPath:
                    name: [metadata, name]
                    customresource_group: [apiVersion]
                    customresource_kind: [kind]
                    customresource_version: [apiVersion]
              labelsFromPath:
                exported_namespace: [metadata, namespace]
                suspended: [spec, suspend]
                ready: [status, conditions, "[type=Ready]", status]
                source_name: [spec, sourceRef, name]
        # Receiver
        - groupVersionKind:
            group: notification.toolkit.fluxcd.io
            version: v1
            kind: Receiver
          metricNamePrefix: gotk
          metrics:
            - name: "resource_info"
              help: "The current state of a GitOps Toolkit resource."
              each:
                type: Info
                info:
                  labelsFromPath:
                    name: [metadata, name]
                    customresource_group: [apiVersion]
                    customresource_kind: [kind]
                    customresource_version: [apiVersion]
              labelsFromPath:
                exported_namespace: [metadata, namespace]
                suspended: [spec, suspend]
                ready: [status, conditions, "[type=Ready]", status]
                webhook_path: [spec, resources, "[0]", path]
